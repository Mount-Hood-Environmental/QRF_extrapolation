---
title: "Documentation for modified -new- QRF model"
author:
- Bryce N. Oldemeyer:
    email: Bryce.Oldemeyer@mounthoodenvironmental.com
    institute: mhe_challis
    correspondence: true
- Mark Roes:
    email: mark.roes@mthoodenvironmental.com
    institute: mhe_sandy
    correspondence: true
- Michael W. Ackerman:
    email: mike.ackerman@mthoodenvironmental.com
    institute: mhe_mccall
    correspondence: false
institute:
- mhe_challis: Mount Hood Environmental, PO Box 1303, Challis, Idaho, 83226, USA
- mhe_sandy: Mount Hood Environmental, 39085 Pioneer Boulevard \#100 Mezzanine, Sandy,
    Oregon, 97055, USA
- mhe_mccall: Mount Hood Environmental, PO Box 4282, McCall, Idaho, 83638, USA

date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    number_sections: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua  
csl: "../templates/american-fisheries-society.csl"
---

<!-- the following inserts MHE logo into header -->

```{=html}
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"logo.jpg\" style=\"float: right;width: 150px;\"/>')
   });
</script>
```
```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 600
)

options(knitr.kable.NA = '--')

```

```{r load-libraries}
# run this if running chunks directly

# for formatting
library(kableExtra)
library(ggpubr)

# for analysis
library(sf)
library(here)
library(tidyverse)
library(magrittr)
library(ggmap)
library(nngeo)
library(janitor)
library(data.table)

theme_set(theme_pubr(x.text.angle = 45,
                     base_size = 8))

```

```{r load-data}
in_path = 'S:/main/data/qrf/gitrepo_data/input/'
out_path = 'S:/main/data/qrf/gitrepo_data/output/'

# load .rda created from the "extrap_comparison_data_prep.R" script
load(paste0(out_path,'gpkg/extrap_compare/US_qrf_extraps_comp.rda'))

# Project area polygons and 200m layer (with habitat attributes) within project area
load(paste0(out_path,'gpkg/extrap_compare/US_spatial.rda'))

# the spatial domain for the species and life stages of the old extrapolations were modified from Morgon Bond's 
# designation to include local knowledge from biologists. To keep things consistent, we will use the same spatial domain
# for the new extrapolations. 

# redds
US_redds_sf_new_extrap = US_redds_sf_new_extrap %>%
  select(-chnk, -sthd) %>%
  st_join(US_redds_sf_old_extrap %>%
            select(chnk, sthd),
          join = st_covered_by,
          left = F)

# summer juv
US_sum_sf_new_extrap = US_sum_sf_new_extrap %>%
  select(-chnk, -sthd) %>%
  st_join(US_sum_sf_old_extrap %>%
            select(chnk, sthd),
          join = st_covered_by,
          left = F)

# winter juv
US_win_sf_new_extrap = US_win_sf_new_extrap %>%
  select(-chnk, -sthd) %>%
  st_join(US_win_sf_old_extrap %>%
            select(chnk, sthd),
          join = st_covered_by,
          left = F)

# convert old sf objects to tibbles
US_sum_df_old_extrap = US_sum_sf_old_extrap %>%
  st_drop_geometry() %>%
  as_tibble()

US_win_df_old_extrap = US_win_sf_old_extrap %>%
  st_drop_geometry() %>%
  as_tibble()

US_redds_df_old_extrap = US_redds_sf_old_extrap %>%
  st_drop_geometry() %>%
  as_tibble()

# convert new sf objects to tibbles
US_sum_df_new_extrap = US_sum_sf_new_extrap %>%
  st_drop_geometry() %>%
  as_tibble()

US_win_df_new_extrap = US_win_sf_new_extrap %>%
  st_drop_geometry() %>%
  as_tibble()

US_redds_df_new_extrap = US_redds_sf_new_extrap %>%
  st_drop_geometry() %>%
  as_tibble()

# create comparison tibbles for mapping

US_sum_sf_comp_extrap = bind_cols(setorder(US_sum_sf_old_extrap[,-c(21:32)], UniqueID), setorder(US_sum_df_new_extrap, UniqueID)[,c(19:30)] - setorder(US_sum_df_old_extrap, UniqueID)[,c(21:32)])

US_win_sf_comp_extrap = bind_cols(setorder(US_win_sf_old_extrap[,-c(21:32)], UniqueID), setorder(US_win_df_new_extrap, UniqueID)[,c(19:30)] - setorder(US_win_df_old_extrap, UniqueID)[,c(21:32)])

US_redds_sf_comp_extrap = bind_cols(setorder(US_redds_sf_old_extrap[,-c(21:32)], UniqueID), setorder(US_redds_df_new_extrap, UniqueID)[,c(19:30)] - setorder(US_redds_df_old_extrap, UniqueID)[,c(21:32)])


```

# Background

Habitat covariates recently used in six quantile random forest (QRF) capacity models (Chinook salmon and steelhead; summer parr, winter presmolts and redds) were chosen because of their high predictive power to estimate capacity across the Columbia River Basin (cite IRA?). However, a subset of the covariates included the QRF models were not necessarily useful for restoration project monitoring, or to describe target conditions for restoration design due to the habitat covariate not being easily manipulated by project actions. Additionally, some of the CHaMP covariates used in previous models were difficult to replicate or measure using streamlined fish habitat protocols (DASH - Carmichael et al. 2019). To increase the utility of the QRF model for project monitoring/design and future data collection efforts, we explored alternative covariates to include in the QRF models that: 1) maintained high predictive power, 2) were informative for restoration efforts and monitoring, 3) could be calculated from DASH surveys, 4) were not missing an overabundance of data, and 5) were not highly correlated with other covariates in the models. Using this criterion, we developed six modified QRF model that were more informative for restoration design and monitoring, included covariates that could be calculated using newly developed stream habitat protocols, and maintained a similar level of predictive power as the original QRF habitat capacity models.

Similarly, a random forest extrapolation model has been used to predict capacity estimates across larger scales where CHaMP or DASH data are absent (cite IRA). We revisited the globally available attributes (GAA) included in the original random forest extrapolation model and made minor modifications so GAA's included in the extrapolation model better aligned with the modified QRF model covariates.

Below is a brief document outlining these efforts, as well as a comparison of extrapolation estimates from the original and modified QRF models for eight watersheds in the Upper Salmon River region.

# Covariate selection

The QRF model was fit using a revised covariate selection process that placed more emphasis on compatibility with future data collection via DASH and the ability to predict restoration effects. Habitat data collected by CHaMP and other sources (e.g. NorWeST stream temperature) were subset to a list of potential covariates that could be reproduced using DASH data collection. This provides opportunity to collect new paired fish and habitat data using DASH protocols, reducing the reliance of the QRF model on the CHaMP habitat data.

Below is the rubric used to inform the covariate selection process for each of the six models (Chinook and steelhead; winter, summer, and redds)

1.  Strength between covariate and response variable (based on MIC score)

2.  Informative for restoration efforts (Yes/No)

3.  Could be calculated using DASH data (Yes/No)

4.  How much data were missing and/or the amount of "0"s?

5.  How correlated was the covariate with other covariates in the original QRF model, and covariates within the same model?

An oversimplified example of the theoretical covariate selection process might unfold as follows. In the original QRF model, discharge was likely included in the model because it had a high MIC score and it made biological sense. Unfortunately, discharge isn't that informative for restoration efforts because most restoration efforts can't create water. Discharge (like many habitat covariates) is highly correlated to other habitat covariates, but these covariates were left out of the original QRF model for any number of reasons (highly correlated with other covariates already in the model, redundant, etc.). Using the rubric, we found that average thalweg depth had a MIC score that was nearly as high as discharge, it was informative for restoration, it could be calculated with DASH, and the two covariates were highly correlated (the high correlation is likely why average thalweg depth was left out of the original QRF model). Based on all the information above, we would substitute mean thalweg depth for discharge in the model. Repeat this process for all other QRF covariates for each of the six models.

The covariate selection process was done independently for both species for all three life stages. At the end of the covariate selection process, final covariates were compared for each life-stage between the two species. While the relative importance of the final covariates selected to be in the models were slightly different between species, the final covariates themselves were nearly identical between species for all three life stages. Because of this, we consolidated the species-specific models and proceeded with one winter juvenile, summer parr, and redd model to be used for both species.

```{r cov-tab}
load(here("data/QRF_new_hab_cov_tbl.rda"))

QRF_new_hab_cov_tbl %>%
  select(-Covariate) %>%
  kable(booktabs = T,
        align = "ccccccccl",
        caption = "Habitat covariates and their descriptions used the three life stage QRF capacity models. Numbers indicate where each metric ranked in relative importance for each species. Dots indicate a metric was not used for a given model.") %>%
  kable_styling(position = "center",
                bootstrap_options = c("striped", "condensed"))

```

# QRF Model fit

Talk about relative importance and pdp plots.

# Extrapolation model

The spatial extent of QRF capacity predictions was limited to reaches CHaMP habitat data, so capacity for all wadable streams in the Columbia basin was estimated through the development of an extrapolation model. This model used 'globally available attributes' (GAAs) obtained from a stream layer created by Morgan Bond and Tyler Nodine based on the National Hydrography Dataset High Resolution 1:24,000 line network to estimate capacities predicted by the QRF model at the 200 meter reach scale. The extrapolation model utilized a random forest model structure. Consistent with the QRF model, the extrapolation model made not assumptions about the direction and distribution of effects of predictors and constrained density estimates within the range of predictions from the QRF model. However, random forest methods did not account for variable strata weights across the CHaMP dataset, a source of potential bias that could be alleviated through the collection of additional paired fish and habitat data.

Extrapolation model covariates were selected from the list of GAAs and examined for inclusion by examining relative importance and partial dependence plots and correlation between covariates. We used the covariates included in the previous extrapolation as a starting point for selection. This resulted in the replacement of regime (an indicator of dominant precipitation type) for elevation and the removal of relative slope, which we found was redundant with gradient. Model results indicated that elevation was consistently one of the most important predictors in the model. This is particularly true for the Chinook parr summer model where capacity predictions were primarily driven by elevation.


```{r gaa-tbl}
load(here("data/gaa_hab_dict.rda"))

gaa_hab_dict %>% 
  select(Metric = Name,
         Decription = DescriptiveText) %>%
  kable(booktabs = T,
        align = "cl",
        caption = "Globally available attritibutes (GAAs) and their descriptions used in the random forest extrapolation model.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

```{r capacity-funs}
source(here("R/calc_watershed_cap.R"))

cap_by_ws = function(x, speciescode){
  ws_list = unique(x$wtrshd)
  
  out = filter(
    bind_rows(
    calc_watershed_cap(US_huc_sf,
                       filter(x, wtrshd == ws_list[1]),
                       capacity_name = paste0(speciescode,"_per_m"),
                       capacity_se_name = paste0(speciescode,"_per_m_se"),
                       by_stream = T) %>%
      mutate(Watershed = ws_list[1]),
  
  calc_watershed_cap(US_huc_sf,
                     filter(x, wtrshd == ws_list[2]),
                     capacity_name = paste0(speciescode,"_per_m"),
                     capacity_se_name = paste0(speciescode,"_per_m_se"),
                     by_stream = T) %>%
      mutate(Watershed = ws_list[2]),
  
  calc_watershed_cap(US_huc_sf,
                     filter(x, wtrshd == ws_list[3]),
                     capacity_name = paste0(speciescode,"_per_m"),
                     capacity_se_name = paste0(speciescode,"_per_m_se"),
                     by_stream = T) %>%
      mutate(Watershed = ws_list[3]),
  
  calc_watershed_cap(US_huc_sf,
                     filter(x, wtrshd == ws_list[4]),
                     capacity_name = paste0(speciescode,"_per_m"),
                     capacity_se_name = paste0(speciescode,"_per_m_se"),
                     by_stream = T) %>%
      mutate(Watershed = ws_list[4]),
  
    calc_watershed_cap(US_huc_sf,
                     filter(x, wtrshd == ws_list[5]),
                     capacity_name = paste0(speciescode,"_per_m"),
                     capacity_se_name = paste0(speciescode,"_per_m_se"),
                     by_stream = T) %>%
      mutate(Watershed = ws_list[5]),
  
    calc_watershed_cap(US_huc_sf,
                     filter(x, wtrshd == ws_list[6]),
                     capacity_name = paste0(speciescode,"_per_m"),
                     capacity_se_name = paste0(speciescode,"_per_m_se"),
                     by_stream = T) %>%
      mutate(Watershed = ws_list[6]),
  
    calc_watershed_cap(US_huc_sf,
                     filter(x, wtrshd == ws_list[7]),
                     capacity_name = paste0(speciescode,"_per_m"),
                     capacity_se_name = paste0(speciescode,"_per_m_se"),
                     by_stream = T) %>%
      mutate(Watershed = ws_list[7]),
  
    calc_watershed_cap(US_huc_sf,
                     filter(x, wtrshd == ws_list[8]),
                     capacity_name = paste0(speciescode,"_per_m"),
                     capacity_se_name = paste0(speciescode,"_per_m_se"),
                     by_stream = T) %>%
      mutate(Watershed = ws_list[8])),
    StreamName != "Total"|is.na(StreamName)) %>%
    group_by(Watershed) %>%
    summarise(across(c(n_rchs,tot_length,tot_cap,tot_cap_se),
              sum,
              na.rm = T),
              .groups = "drop")

  return(out)
}

```

```{r calc-chnk-capacity}

# Chinook salmon, summer parr
chnk_sum_cap_new = cap_by_ws(US_sum_sf_new_extrap, "chnk") %>%
  mutate(modelname = "juv_summer")

# Chinook salmon, winter presmolt
chnk_win_cap_new = cap_by_ws(US_win_sf_new_extrap, "chnk") %>%
  mutate(modelname = "juv_winter")

# Chinook salmon, redds
chnk_redd_cap_new = cap_by_ws(US_redds_sf_new_extrap, "chnk") %>%
  mutate(modelname = "redds")

# Old extraps for comparison ####
# Chinook salmon, summer parr
chnk_sum_cap_old = cap_by_ws(US_sum_sf_old_extrap, "chnk")

# Chinook salmon, winter presmolt
chnk_win_cap_old = cap_by_ws(US_win_sf_old_extrap, "chnk")

# Chinook salmon, redds
chnk_redd_cap_old = cap_by_ws(US_redds_sf_old_extrap, "chnk")

```

```{r calc-sthd-capacity}

# steelhead salmon, summer parr
sthd_sum_cap_new = cap_by_ws(US_sum_sf_new_extrap, "sthd") %>%
  mutate(modelname = "juv_summer")

# steelhead salmon, winter presmolt
sthd_win_cap_new = cap_by_ws(US_win_sf_new_extrap, "sthd") %>%
  mutate(modelname = "juv_winter")

# steelhead salmon, redds
sthd_redd_cap_new = cap_by_ws(US_redds_sf_new_extrap, "sthd") %>%
  mutate(modelname = "redds")

# Old extraps for comparison ####
# steelhead salmon, summer parr
sthd_sum_cap_old = cap_by_ws(US_sum_sf_old_extrap, "sthd")

# steelhead salmon, winter presmolt
sthd_win_cap_old = cap_by_ws(US_win_sf_old_extrap, "sthd")

# steelhead salmon, redds
sthd_redd_cap_old = cap_by_ws(US_redds_sf_old_extrap, "sthd")
```

```{r create-chnk-maps}
# pick a background river color
river_color = "lightskyblue1"

#New extrap maps####
# chinook summer parr
chnk_sum_map = US_sum_sf_new_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_sum_sf_new_extrap %>%
            filter(chnk),
          aes(color = chnk_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Chinook, Summer Juveniles",
       color = expression(`Summer Juv` / m^2))

# chinook winter presmolts
chnk_win_map = US_win_sf_new_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_win_sf_new_extrap %>%
            filter(chnk),
          aes(color = chnk_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Chinook, Winter Juveniles",
       color = expression(`Winter Juv` / m^2))

# chinook redds
chnk_redd_map = US_redds_sf_new_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_redds_sf_new_extrap %>%
            filter(chnk) %>%
            mutate(chnk_per_km = chnk_per_m * 1000),
          aes(color = chnk_per_km),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Chinook, Redds",
       color = expression(Redds / km))

#Comparison maps####
# chinook summer parr
chnk_sum_comp_map = US_sum_sf_comp_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_sum_sf_comp_extrap %>%
            filter(chnk),
          aes(color = chnk_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Chinook, Summer Juveniles",
       color = expression(`Summer Juv` / m^2))

# chinook winter presmolts
chnk_win_comp_map = US_win_sf_comp_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_win_sf_comp_extrap %>%
            filter(chnk),
          aes(color = chnk_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Chinook, Winter Juveniles",
       color = expression(`Winter Juv` / m^2))

# chinook redds
chnk_redd_comp_map = US_redds_sf_comp_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_redds_sf_comp_extrap %>%
            filter(chnk) %>%
            mutate(chnk_per_km = chnk_per_m * 1000),
          aes(color = chnk_per_km),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Chinook, Redds",
       color = expression(Redds / km))
    

```

```{r create-sthd-maps}
# steelhead summer juveniles
sthd_sum_map = US_sum_sf_new_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_sum_sf_new_extrap %>%
            filter(sthd),
          aes(color = sthd_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Steelhead, Summer Juveniles",
       color = expression(`Summer Juv` / m^2))

# steelhead winter juveniles
sthd_win_map = US_win_sf_new_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_win_sf_new_extrap %>%
            filter(sthd),
          aes(color = sthd_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Steelhead, Winter Juveniles",
       color = expression(`Winter Juv` / m^2))

# steelhead redds
sthd_redd_map = US_redds_sf_new_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_redds_sf_new_extrap %>%
            filter(sthd) %>%
            mutate(sthd_per_km = sthd_per_m * 1000),
          aes(color = sthd_per_km),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Steelhead, Redds",
       color = expression(Redds / km))

# Comparison maps ####
# steelhead summer juveniles
sthd_sum_comp_map = US_sum_sf_comp_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_sum_sf_comp_extrap %>%
            filter(sthd),
          aes(color = sthd_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Steelhead, Summer Juveniles",
       color = expression(`Summer Juv` / m^2))

# steelhead winter juveniles
sthd_win_comp_map = US_win_sf_comp_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_win_sf_comp_extrap %>%
            filter(sthd),
          aes(color = sthd_per_m2),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Steelhead, Winter Juveniles",
       color = expression(`Winter Juv` / m^2))

# steelhead redds
sthd_redd_comp_map = US_redds_sf_comp_extrap %>%
  ggplot() +
  geom_sf(data = US_huc_sf %>%
            st_union() %>%
            nngeo::st_remove_holes(),
          fill = NA,
          color = "gray50") +
  geom_sf(color = river_color) +
  geom_sf(data = US_redds_sf_comp_extrap %>%
            filter(sthd) %>%
            mutate(sthd_per_km = sthd_per_m * 1000),
          aes(color = sthd_per_km),
          size = 1) +
  scale_color_viridis_c(direction = -1) +
  #theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) +
  labs(title = "Steelhead, Redds",
       color = expression(Redds / km))

```

```{r chnk-maps, fig.cap = "Extrapolations of habitat capacity for Chinook salmon, by life-stage, for the eight watersheds within the Upper Salmon River Basin using the modified models."}
ggarrange(chnk_sum_map,
          chnk_win_map,
          chnk_redd_map)

```

```{r sthd-maps, fig.cap = "Extrapolations of habitat capacity for steelhead, by life-stage, for the eight watersheds within the Upper Salmon River Basin using the modified models."}
ggarrange(sthd_sum_map,
          sthd_win_map,
          sthd_redd_map)

```

::: {#refs}
:::

# Habitat Capacity Estimates

### Chinook Salmon

```{r chnk-cap-summarytbl}
chnk_cap_summary = bind_rows(chnk_sum_cap_new,
          chnk_win_cap_new,
          chnk_redd_cap_new) %>%
  select(Watershed, modelname, tot_cap, tot_cap_se) %>%
  pivot_wider(names_from = modelname, values_from = c(tot_cap, tot_cap_se)) %>%
  select(Watershed, tot_cap_juv_summer, tot_cap_se_juv_summer,
         tot_cap_juv_winter, tot_cap_se_juv_winter,
         tot_cap_redds, tot_cap_se_redds) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,1,0,1),
        align = "lccccccc",
        format.args = list(big.mark = ","),
        col.names = c("Watershed", "Juv summer capacity", "Summer SE", "Juv winter capacity", "Winter SE", "Redd capacity", "Redd SE" ),
        caption = "Predicted Chinook salmon habitat capacity by life-stage and watershed using the modified models.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

bind_rows(chnk_sum_cap_new,
          chnk_win_cap_new,
          chnk_redd_cap_new) %>%
  select(Watershed, modelname, tot_cap, tot_cap_se, tot_length) %>%
  mutate(cap_km = tot_cap/(tot_length/1000),
         cap_km_se = tot_cap_se/(tot_length/1000)) %>%
  select(Watershed, modelname, cap_km,cap_km_se) %>%
  pivot_wider(names_from = modelname, values_from = c(cap_km, cap_km_se)) %>%
  select(Watershed, cap_km_juv_summer, cap_km_se_juv_summer,
         cap_km_juv_winter, cap_km_se_juv_winter,
         cap_km_redds, cap_km_se_redds) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,1,0,1),
        align = "lcccccc",
        format.args = list(big.mark = ","),
        col.names = c("Watershed", "Juv summer capacity/km", "Summer SE/km", "Juv winter capacity/km", "Winter SE/km", "Redd capacity/km", "Redd SE/km" ),
        caption = "Predicted Chinook salmon habitat capacity per kilometer by life-stage and watershed using the modified models.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))


```

### Steelhead

```{r sthd-cap-summarytbl}
bind_rows(sthd_sum_cap_new,
          sthd_win_cap_new,
          sthd_redd_cap_new) %>%
  select(Watershed, modelname, tot_cap, tot_cap_se) %>%
  pivot_wider(names_from = modelname, values_from = c(tot_cap, tot_cap_se)) %>%
  select(Watershed, tot_cap_juv_summer, tot_cap_se_juv_summer,
         tot_cap_juv_winter, tot_cap_se_juv_winter,
         tot_cap_redds, tot_cap_se_redds) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        col.names = c("Watershed", "Juv summer capacity", "Summer SE", "Juv winter capacity", "Winter SE", "Redd capacity", "Redd SE" ),
        caption = "Predicted steelhead habitat capacity by life-stage and watershed using the modified models.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))


bind_rows(sthd_sum_cap_new,
          sthd_win_cap_new,
          sthd_redd_cap_new) %>%
  select(Watershed, modelname, tot_cap, tot_cap_se, tot_length) %>%
  mutate(cap_km = tot_cap/(tot_length/1000),
         cap_km_se = tot_cap_se/(tot_length/1000)) %>%
  select(Watershed, modelname, cap_km,cap_km_se) %>%
  pivot_wider(names_from = modelname, values_from = c(cap_km, cap_km_se)) %>%
  select(Watershed, cap_km_juv_summer, cap_km_se_juv_summer,
         cap_km_juv_winter, cap_km_se_juv_winter,
         cap_km_redds, cap_km_se_redds) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,1,0,1),
        align = "lcccccc",
        format.args = list(big.mark = ","),
        col.names = c("Watershed", "Juv summer capacity/km", "Summer SE/km", "Juv winter capacity/km", "Winter SE/km", "Redd capacity/km", "Redd SE/km" ),
        caption = "Predicted steelhead habitat capacity per kilometer by life-stage and watershed using the modified models.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))
```

## Comparison with previous extrapolation

Comparisons of watershed capacity estimates from the previous QRF and extrapolation model and the new revised versions reveal modest differences in most cases, with an exception of Chinook parr summer capacities in several watersheds. The substantial increases in Chinook parr summer capacity are likely due to the inclusion of elevation in the extrapolation model and range from 21 - 222% compared to the previous extrapolation.

### Chinook

```{r chnk-maps-comp, fig.cap = "Comparison of Chinook salmon habitat capacity estimates between revised and original model extrapolation, by life-stage, for the eight watersheds within the Upper Salmon River Basin."}
ggarrange(chnk_sum_comp_map,
          chnk_win_comp_map,
          chnk_redd_comp_map)

```

```{r chnk-comp-summary-tbls}

capcompare = function(cap_new,cap_old,modelname){
  out = cap_new[,c(1,3,4,5)] %>%
  left_join(cap_old[,c(1,4,5)], by = "Watershed", suffix = c("_new","_old")) %>%
  mutate(Model = modelname,
         cap_change_percent = (tot_cap_new/tot_cap_old-1) * 100,
         cap_km = tot_cap_new/(tot_length/1000)) %>%
    select(Model, 
           Watershed,
           cap_km,
           tot_cap_new, 
           cap_change_percent, 
           tot_cap_se_new)
  
}

bind_rows(
  capcompare(chnk_sum_cap_new, chnk_sum_cap_old, "Juv summer"),
  capcompare(chnk_win_cap_new, chnk_win_cap_old, "Juv winter"),
  capcompare(chnk_redd_cap_new, chnk_redd_cap_old, "Redds")) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0,0,0),
        align = "lcccccc",
        format.args = list(big.mark = ","),
        col.names = c("Model", "Watershed", "Capacity per km", "Total capacity", "Capacity % change", "Capacity SE"),
        caption = "Estimated **chinook** capacities and comparison with previous  random forest extrapolations for eight watersheds") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed")) %>%
  collapse_rows(columns = 1:2) #collapse rows is currently broken, hopefully will be fixed soon



```

### Steelhead

```{r sthd-maps-comp, fig.cap = "Comparison of steelhead habitat capacity estimates between modified  and original models extrapolation, by life-stage, for the eight watersheds within the Upper Salmon River Basin."}
ggarrange(sthd_sum_comp_map,
          sthd_win_comp_map,
          sthd_redd_comp_map)

```

```{r sthd-comp-summary-tbls}

sthd_summary = bind_rows(
  capcompare(sthd_sum_cap_new, sthd_sum_cap_old, "Juv summer"),
  capcompare(sthd_win_cap_new, sthd_win_cap_old, "Juv winter"),
  capcompare(sthd_redd_cap_new, sthd_redd_cap_old, "Redds"))

sthd_summary %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0,0,0),
        align = "lcccccc",
        format.args = list(big.mark = ","),
        col.names = c("Model", "Watershed", "Capacity per km", "Total capacity", "Capacity % change", "Capacity SE" ),
        caption = "Estimated **steelhead** capacities and comparison with previous  random forest extrapolations for eight watersheds") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed")) %>%
    collapse_rows(columns = 1:2) #collapse rows is currently broken, hopefully will be fixed soon


```

# Supplemental figures and tables

## QRF partial dependence plots
```{r qrf-pdp-summer, caption = "Partial dependence plots for covariates included in the juvenile summer QRF models"}

load(here('output/figures/juv_summer_figs.rda'))
chnk_pdp
sthd_pdp

```

```{r qrf-pdp-winter, caption = "Partial dependence plots for covariates included in the juvenile winter QRF models"}

load(here('output/figures/juv_winter_figs.rda'))
chnk_pdp
sthd_pdp

```

```{r qrf-pdp-redds, caption = "Partial dependence plots for covariates included in the QRF redds models"}

load(here('output/figures/redds_figs.rda'))
chnk_pdp
sthd_pdp

```

## Capacity by stream

### Chinook

```{r chnk-sum-tbl, eval = F}
chnk_sum_cap_new %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        col.names = c("Stream Name","Reaches","Stream Length (km)", "Capacity","Capacity SE"),
        caption = "Estimated available habitat for **juvenile summer rearing** Chinook salmon in the eight salmon watershedss.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

```{r chnk-win-tbl, eval = F}
chnk_win_cap_new %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        col.names = c("Stream Name","Reaches","Stream Length (km)", "Capacity","Capacity SE"),
        caption = "Estimated available habitat for **juvenile winter rearing** Chinook salmon in the eight salmon watersheds.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

```{r chnk-redd-tbl, eval = F}
chnk_redd_cap_new %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        col.names = c("Stream Name","Reaches","Stream Length (km)", "Capacity","Capacity SE"),
        caption = "Estimated available **spawning (redds)** habitat for Chinook salmon in the eight salmon watersheds.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

### Steelhead

```{r sthd-sum-tbl, eval = F}
sthd_sum_cap_new %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        col.names = c("Stream Name","Reaches","Stream Length (km)", "Capacity","Capacity SE"),
        caption = "Estimated available habitat for **juvenile summer rearing** steelhead in the eight salmon watersheds.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```

```{r sthd-win-tbl, eval = F}
sthd_win_cap_new %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        col.names = c("Stream Name","Reaches","Stream Length (km)", "Capacity","Capacity SE"),
        caption = "Estimated available habitat for **juvenile winter rearing** steelhead in the eight salmon watersheds.") %>%
  kable_styling(full_width = F,
                position = "center",

                bootstrap_options = c("striped", "condensed"))

```

```{r sthd-redd-tbl, eval = F}
sthd_redd_cap_new %>%
  subset(!StreamName == "Total" | is.na(StreamName)) %>%
  adorn_totals() %>%
  mutate(tot_length = tot_length / 1000) %>%
  rename(`n Reaches` = n_rchs,
         `Stream Length (km)` = tot_length,
         Capacity = tot_cap,
         `Capacity SE` = tot_cap_se) %>%
  kable(booktabs = T,
        digits = c(0,0,1,0,0),
        align = "lcccc",
        format.args = list(big.mark = ","),
        col.names = c("Stream Name","Reaches","Stream Length (km)", "Capacity","Capacity SE"),
        caption = "Estimated available **spawning (redds)** habitat for steelhead in the eight salmon watersheds.") %>%
  kable_styling(full_width = F,
                position = "center",
                bootstrap_options = c("striped", "condensed"))

```
